<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.unique.org.dao.StaffMapper" >
  <resultMap id="BaseResultMap" type="com.unique.reg.po.Staff" >
    <id column="STAFF_ID" jdbcType="DECIMAL" property="staffId" />
    <result column="ORG_ID" jdbcType="DECIMAL" property="orgId" />
    <result column="DEP_ID" jdbcType="DECIMAL" property="depId" />
    <result column="STAFF_TYPE_ID" jdbcType="DECIMAL" property="staffTypeId" />
    <result column="USER_ID" jdbcType="DECIMAL" property="userId" />
    <result column="ORG_NAME" jdbcType="VARCHAR" property="orgName" />
    <result column="DEP_NAME" jdbcType="VARCHAR" property="depName" />
    <result column="STAFF_CODE" jdbcType="VARCHAR" property="staffCode" />
    <result column="STAFF_NAME" jdbcType="VARCHAR" property="staffName" />
    <result column="HOME_TEL" jdbcType="VARCHAR" property="homeTel" />
    <result column="BIRTH" jdbcType="VARCHAR" property="birth" />
    <result column="SEX" jdbcType="CHAR" property="sex" />
    <result column="MONEY_BAG" jdbcType="VARCHAR" property="moneyBag" />
    <result column="WEDLOCK" jdbcType="DECIMAL" property="wedlock" />
    <result column="HOME_ADDR" jdbcType="VARCHAR" property="homeAddr" />
    <result column="BIRTH_CITY" jdbcType="VARCHAR" property="birthCity" />
    <result column="FOLK" jdbcType="DECIMAL" property="folk" />
    <result column="RESIDE_CITY" jdbcType="VARCHAR" property="resideCity" />
    <result column="STATUS" jdbcType="CHAR" property="status" />
    <result column="ID_CARD" jdbcType="VARCHAR" property="idCard" />
    <result column="GOOT_AT" jdbcType="VARCHAR" property="gootAt" />
    <result column="STAFF_DESC" jdbcType="VARCHAR" property="staffDesc" />
    <result column="SPELLING" jdbcType="VARCHAR" property="spelling" />
    <result column="AVGTIME" jdbcType="DECIMAL" property="avgtime" />
    <result column="STAFF_UNIQUE_ID" jdbcType="VARCHAR" property="staffUniqueId" />
    <result column="DUTY_DATE_NUM" jdbcType="DECIMAL" property="dutyDateNum" />
    <result column="IS_CONSULT" jdbcType="CHAR" property="isConsult" />
    <result column="E_MAIL" jdbcType="VARCHAR" property="eMail" />
    <result column="IS_REG" jdbcType="CHAR" property="isReg" />
    <result column="OPERATOR" jdbcType="DECIMAL" property="operator" />
    <result column="OPERATOR_NAME" jdbcType="VARCHAR" property="operatorName" />
    <result column="OP_TIME" jdbcType="TIMESTAMP" property="opTime" />
    <result column="SORT_RANK" jdbcType="DECIMAL" property="sortRank" />
    <result column="IS_RECOMMEND" jdbcType="CHAR" property="isRecommend" />
    <result column="IS_OPEN_HEALTY" jdbcType="CHAR" property="isOpenHealty" />
    <result column="HEALTY_USER_NUMBER" jdbcType="DECIMAL" property="healtyUserNumber" />
  </resultMap>
  <resultMap type="com.unique.reg.po.Staff" id="staffResult" extends="BaseResultMap">
  	<result column="STAFF_TYPE_NAME" property="staffTypeName" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap type="com.unique.reg.po.Staff" id="staffAllResult" extends="staffResult">
  	<result column="STAFF_ICON" property="staffIcon" jdbcType="VARCHAR" />
  </resultMap>
  
  <resultMap id="staffTypeResultMap" type="com.unique.org.po.StaffType" >
    <id column="STAFF_TYPE_ID" property="staffTypeId" jdbcType="DECIMAL" />
    <result column="TYPE_GROUP_ID" property="typeGroupId" jdbcType="DECIMAL" />
    <result column="STAFF_TYPE_CODE" property="staffTypeCode" jdbcType="VARCHAR" />
    <result column="STAFF_TYPE_NAME" property="staffTypeName" jdbcType="VARCHAR" />
    <result column="STAFF_TYPE_SYMBOL" property="staffTypeSymbol" jdbcType="VARCHAR" />
    <result column="CHARGE_TYPE_NAME" property="chargeTypeName" jdbcType="VARCHAR" />
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
    <result column="SORT_RANK" property="sortRank" jdbcType="DECIMAL" />
    <result column="STATUS" property="status" jdbcType="CHAR" />
    <result column="OPERATOR" property="operator" jdbcType="DECIMAL" />
    <result column="OP_TIME" property="opTime" jdbcType="TIMESTAMP" />
    <result column="OPERATOR_NAME" property="operatorName" jdbcType="VARCHAR" />
    <result column="ORG_ID" property="orgId" jdbcType="DECIMAL" />
  </resultMap>
  <select id="getStaff4Lucence" parameterType="map" resultMap="BaseResultMap">
  select * from staff where 1=1
  <if test="lastTime!=null">
  <![CDATA[
   and staff.op_time > #{lastTime}
  ]]>
  </if>
  <if test="ids != null" >
 	 and staff.staff_id in (
  	<foreach collection="ids" item="id" separator=",">
  	#{id}
  	</foreach>
  	)
  </if>
  </select>
  
  <resultMap id="FavoriteResultMap" type="com.unique.org.po.UserFavor" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="OID" property="oid" jdbcType="DECIMAL" />
    <result column="USER_ID" property="userId" jdbcType="DECIMAL" />
    <result column="FAVOR_TYPE" property="favorType" jdbcType="CHAR" />
    <result column="FAVOR_ID" property="favorId" jdbcType="DECIMAL" />
    <result column="FAVOR_CON" property="favorCon" jdbcType="VARCHAR" />
    <result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" />
    <result column="FAVOR_VALUE" property="favorValue" jdbcType="DECIMAL" />
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
    <result column="STATUS" property="status" jdbcType="CHAR" />
  </resultMap>
  
  <!-- 最近预约过的医生 -->
   <select id="getRecentStaff" resultMap="staffResult"
		 parameterType="java.lang.String">
		<![CDATA[
		 	select distinct s.*,staff_type.staff_type_name,reg.create_time from staff s join
		 	   (select r.* from mc_reg r where r.operator=#{userId}) reg
		 	 on s.staff_id=reg.staff_id
		 	left join staff_type on staff_type.staff_type_id = s.staff_type_id
		 	 where s.status='C'
		 	 order by reg.create_time desc
		 	]]>
	</select>
	
  <!-- 通过科室获取医生 -->
   <select id="getStaffByDep" resultMap="staffAllResult" parameterType="map">
 	 <if test="startRow != null and endRow!=null">
	  	<include refid="com.unique.core.fenye1"></include>
	 </if>
 	   select s.*,cms_img_lib.hlink_to as staff_icon,staff_type.staff_type_name from staff s  
       left join cms_img_lib on cms_img_lib.staff_id = s.staff_id
       left join staff_type  on staff_type.staff_type_id=s.staff_type_id
 	   where s.dep_id=#{depId} or s.dep_id in (select d.dep_id from dep d where d.parent_id=#{depId}) and s.status='C' order by s.SORT_RANK
 	  <if test="startRow != null and endRow!=null">
	  	<include refid="com.unique.core.fenye2"></include>
	  </if>
   </select>
   <select id="getStaffByDepCount" resultType="long" parameterType="java.lang.String">
		<![CDATA[
		 	select count(s.staff_id) from staff s  
		 	where s.dep_id=#{depId} or s.dep_id in (select d.dep_id from dep d where d.parent_id=#{dep_id})
		 	and s.status='C'
		 	]]>
	</select>
	
	<!-- 医生详情 by staff_id -->
	<select id="getStaffDetailById" resultMap="BaseResultMap"
		 parameterType="java.lang.String">
		<![CDATA[
		 	select s.* from staff s where s.staff_id=#{staffId} and nvl(s.status,'C')='C'
		 	]]>
	</select>
  
  <!-- 关注列表 -->
  <select id="getFavorList" resultMap="staffAllResult" parameterType="map">
	 <include refid="com.unique.core.fenye1"></include>
		<![CDATA[
		 	select s.*,t.staff_type_name, cms_img_lib.hlink_to as staff_icon
			  from user_favor f
			  join staff s on f.favor_id = s.staff_id
			  left join staff_type t on t.staff_type_id=s.staff_type_id
			   left join cms_img_lib on cms_img_lib.staff_id = s.staff_id
			 where f.favor_type = '1'
			 and (f.status='C' or f.status='U')
			 and s.status='C'
			 and f.user_id=#{userId}
		 	]]>
	 	<include refid="com.unique.core.fenye2"></include>
	</select>
  <!-- 关注列表总数 -->
  <select id="getFavorListCount" resultType="int" parameterType="java.lang.String">
		<![CDATA[
		 	select count(s.staff_id)
			  from user_favor f
			  join staff s on f.favor_id = s.staff_id
			  left join staff_type t on t.staff_type_id=s.staff_type_id
			 where f.favor_type = '1'
			 and (f.status='C' or f.status='U')
			 and s.status='C'
			 and f.user_id=#{userId}
		 	]]>
	</select>
	<!-- 获取当前用户的这个医生是否被关注 -->
	<select id="getFavorByStaffIdAndUserId" parameterType="map" resultType="long">
		select count(user_id) from user_favor where user_id=#{userId} and favor_Id=#{staffId} and status!='R'
	</select>
	
	<!-- 关注的一个医生-->
   <select id="getFavor" resultMap="FavoriteResultMap"
		 parameterType="com.unique.org.po.UserFavor">
		<![CDATA[
		 	select f.*
			  from user_favor f
			  join staff s on f.favor_id = s.staff_id
			 where f.favor_type = '1'
			 and s.status='C'
			 and f.user_id=#{userId,jdbcType=DECIMAL}
			 and f.FAVOR_ID=#{favorId,jdbcType=DECIMAL}
		 	]]>
	</select>

  <!-- 添加关注医生 -->
  <insert id="addFavor" parameterType="com.unique.org.po.UserFavor" >
      <selectKey keyProperty="oid" resultType="DECIMAL" order="BEFORE">
		select SEQ_USER_FAVOR.nextval as oid from dual
      </selectKey>
     insert into USER_FAVOR (OID, USER_ID, FAVOR_TYPE, 
      FAVOR_ID, FAVOR_CON, CREATE_TIME, 
      FAVOR_VALUE, REMARK, STATUS
      )
    values (#{oid,jdbcType=DECIMAL}, #{userId,jdbcType=DECIMAL}, #{favorType,jdbcType=CHAR}, 
      #{favorId,jdbcType=DECIMAL}, #{favorCon,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP}, 
      #{favorValue,jdbcType=DECIMAL}, #{remark,jdbcType=VARCHAR}, #{status,jdbcType=CHAR}
      )
  </insert>
  
  <!-- 取消or重新关注医生 -->
  <update id="updateFavorStatus" parameterType="com.unique.org.po.UserFavor" >
     update USER_FAVOR set STATUS=#{status,jdbcType=CHAR} where USER_ID=#{userId,jdbcType=DECIMAL} and FAVOR_TYPE='1' and FAVOR_ID=#{favorId,jdbcType=DECIMAL}
  </update>
  
  <select id="getStaffByUnicodeID" parameterType="map" resultMap="BaseResultMap">
  	select * from staff where staff.staff_unique_id=#{uniqueId}
  </select>
  <select id="getStaffByCode" parameterType="map" resultMap="BaseResultMap">
  	select * from staff where staff.staff_code=#{code}
  </select>
  
  <select id="getStaffTypeByCode" resultMap="staffTypeResultMap" parameterType="string">
  select * from staff_type where staff_type.staff_type_code = #{typeCode}
  </select>
  <insert id="addStaff" parameterType="com.unique.reg.po.Staff" >
      <selectKey keyProperty="staffId" resultType="DECIMAL" order="BEFORE">
		select seq_staff.nextval as staffId from dual
      </selectKey>
    insert into STAFF (STAFF_ID, ORG_ID, DEP_ID, 
      STAFF_TYPE_ID, USER_ID, ORG_NAME, 
      DEP_NAME, STAFF_CODE, STAFF_NAME, 
      HOME_TEL, BIRTH, SEX, MONEY_BAG, 
      WEDLOCK, HOME_ADDR, BIRTH_CITY, 
      FOLK, RESIDE_CITY, STATUS, 
      ID_CARD, GOOT_AT, STAFF_DESC, 
      SPELLING, AVGTIME, STAFF_UNIQUE_ID, 
      DUTY_DATE_NUM, IS_CONSULT, E_MAIL, 
      IS_REG, OPERATOR, OPERATOR_NAME, 
      OP_TIME, SORT_RANK)
    values (#{staffId,jdbcType=DECIMAL}, #{orgId,jdbcType=DECIMAL}, #{depId,jdbcType=DECIMAL}, 
      #{staffTypeId,jdbcType=DECIMAL}, #{userId,jdbcType=DECIMAL}, #{orgName,jdbcType=VARCHAR}, 
      #{depName,jdbcType=VARCHAR}, #{staffCode,jdbcType=VARCHAR}, #{staffName,jdbcType=VARCHAR}, 
      #{homeTel,jdbcType=VARCHAR}, #{birth,jdbcType=VARCHAR}, #{sex,jdbcType=CHAR}, #{moneyBag,jdbcType=VARCHAR}, 
      #{wedlock,jdbcType=DECIMAL}, #{homeAddr,jdbcType=VARCHAR}, #{birthCity,jdbcType=VARCHAR}, 
      #{folk,jdbcType=DECIMAL}, #{resideCity,jdbcType=VARCHAR}, #{status,jdbcType=CHAR}, 
      #{idCard,jdbcType=VARCHAR}, #{gootAt,jdbcType=VARCHAR}, #{staffDesc,jdbcType=VARCHAR}, 
      #{spelling,jdbcType=VARCHAR}, #{avgtime,jdbcType=DECIMAL}, #{staffUniqueId,jdbcType=VARCHAR}, 
      #{dutyDateNum,jdbcType=DECIMAL}, #{isConsult,jdbcType=CHAR}, #{eMail,jdbcType=VARCHAR}, 
      #{isReg,jdbcType=CHAR}, #{operator,jdbcType=DECIMAL}, #{operatorName,jdbcType=VARCHAR}, 
      #{opTime,jdbcType=TIMESTAMP}, #{sortRank,jdbcType=DECIMAL})
  </insert>
  
  
  <select id="getStaffInfo" resultMap="staffAllResult" parameterType="string">
    select staff.*,
    cms_img_lib.hlink_to as staff_icon,
    staff_type.staff_type_name
     from staff
     left join staff_type on staff_type.staff_type_id = staff.staff_type_id
     left join cms_img_lib on cms_img_lib.staff_id = staff.staff_id
      where staff.staff_id = #{staffId}
  </select>
  
  <select id="getStaffInfoByUserId" resultMap="staffAllResult" parameterType="string">
  <![CDATA[
    select staff.*,cms_img_lib.hlink_to as staff_icon,
    staff_type.staff_type_name as staff_type_name
     from staff
     left join staff_type on staff_type.staff_type_id = staff.staff_type_id
     left join cms_img_lib on cms_img_lib.staff_id = staff.staff_id
      where staff.user_id = #{userId}
    ]]>
  </select>
 
  <select id="getStaffFans" parameterType="string" resultType="long">
         select count(*) from user_favor where user_favor.favor_type = 1  and user_favor.status in ('C','U') and user_favor.favor_id = #{staffId}
  </select>
  
  <!-- 通过当前医生的机构Id（医院），获取当前所属机构下的医生通讯录 -->
  <resultMap type="com.unique.org.vo.MailList" id="mailListMap">
  	 <result column="DEP_NAME" jdbcType="VARCHAR" property="depName" />
     <result column="STAFF_NAME" jdbcType="VARCHAR" property="staffName" />
     <result column="HOME_TEL" jdbcType="VARCHAR" property="homeTel" />
  </resultMap>
  
  <!-- 获取医院通讯录 分页 -->
  <select id="getMailListPage" resultMap="mailListMap" parameterType="map">
  	<if test="startRow != null and endRow!=null">
  		<include refid="com.unique.core.fenye1"></include>
    </if>
     SELECT staff.staff_name,dep.dep_name,staff.home_tel FROM staff 
     left join dep on dep.dep_id=staff.dep_id
     WHERE staff.org_id=#{orgId}
  	<if test="staffName != null">
 		and staff.staff_name like '%'||#{staffName}||'%'
  	</if>
  	order by staff.staff_name
  	<if test="startRow != null and endRow!=null">
		<include refid="com.unique.core.fenye2"></include>
	</if>
  </select>
   
   <!-- 通讯录总行数 -->
   <select id="getMailListPageCount" parameterType="map" resultType="long">
  	SELECT count(staff_id) FROM staff WHERE org_id=#{orgId}
  	<if test="staffName != null">
 		and staff_name like '%'||#{staffName}||'%'
  	</if>
  </select>
  
  <!-- 修改医生简单信息 -->
  <update id="modStaffSimpleInfo" parameterType="com.unique.reg.po.Staff">
  	  UPDATE staff SET 
  	     <if test="orgId != null">
  	     	 ORG_ID = #{orgId}
  	     </if>
  	      <if test="depId != null">
  	     	 DEP_ID = #{depId}
  	     </if>
  	     <if test="staffTypeId != null">
  	     	 STAFF_TYPE_ID = #{staffTypeId}
  	     </if>
  	      <if test="orgName != null">
  	     	 ORG_NAME = #{orgName}
  	     </if>
  	      <if test="depName != null">
  	     	 DEP_NAME = #{depName}
  	     </if>
  	     <if test="staffDesc != null">
  	     	 STAFF_DESC = #{staffDesc}
  	     </if>
  	     <if test="gootAt != null">
  	     	 GOOT_AT = #{gootAt}
  	     </if>
  	  WHERE staff_id = #{staffId} 
  </update>
  
  <select id="getFamousDoctor" resultMap="staffAllResult" parameterType="string">
  	<![CDATA[
  		select 
  			s.staff_id,s.user_id,s.goot_at,s.staff_desc,s.dep_name,s.staff_name,t.staff_type_name,c.hlink_to as staff_icon
  		from staff s
  		left join staff_type t on s.staff_type_id=t.staff_type_id
  		left join cms_img_lib c on c.staff_id = s.staff_id
  		where s.org_id=#{orgId} and s.IS_RECOMMEND='Y'  and nvl(s.status,'C')='C' and  rownum < 51
  	]]>
  </select>
  
  <!-- 医生搜索 -->
   <resultMap id="searchStaffMap" type="com.unique.org.vo.StaffBaseInfo" >
    <result column="staff_id" property="staffId" jdbcType="DECIMAL" />
    <result column="staff_name" property="staffName" jdbcType="VARCHAR" />
    <result column="dep_name" property="depName" jdbcType="VARCHAR" />
    <result column="staff_type_name" property="staffTypeName" jdbcType="VARCHAR" />
    <result column="goot_at" property="gootAt" jdbcType="VARCHAR" />
    <result column="staff_icon" property="staffIcon" jdbcType="VARCHAR" />
  </resultMap>
  <select id="searchStaff" resultMap="searchStaffMap" parameterType="map">
  	  select 
  	  	s.staff_id,s.goot_at,s.dep_name,s.staff_name,t.staff_type_name,c.hlink_to as staff_icon
  	  from staff s 
  	  left join staff_type t on s.staff_type_id=t.staff_type_id
  	  left join cms_img_lib c on c.staff_id = s.staff_id
  	  where s.org_id=#{orgId} and nvl(s.status,'C')='C' 
  	  <if test="staffName!=null">
  	  	and s.staff_name like '%'||#{staffName}||'%'  
  	  </if>
  	  order by s.staff_name
  </select>
  <select id="searchStaffCount" resultType="long" parameterType="map">
  	  select count(*) from staff  where org_id=#{orgId} and nvl(status,'C')='C' 
  	  <if test="staffName!=null">
  	  	and staff_name like '%'||#{staffName}||'%'  
  	  </if>
  </select>
  
  <!-- 查询相同科室下的推荐医生 -->
  <select id="getSameDepReCommendStaff" resultMap="staffAllResult" parameterType="string">
  	select * from (
	select staff.*,staff_type.staff_type_name,cms_img_lib.hlink_to as staff_icon from staff
	left join staff_type on staff_type.staff_type_id=staff.staff_type_id 
	left join cms_img_lib on cms_img_lib.staff_id = staff.staff_id
	left join 
	(    
	   select user_doctor_relation.staff_id,count(user_doctor_relation.staff_id) s_count from user_doctor_relation group by user_doctor_relation.staff_id
	 ) temp
	 on staff.staff_id=temp.staff_id 
	 where 
	   staff.IS_OPEN_HEALTY='Y'
	   and staff.HEALTY_USER_NUMBER>0 and staff.HEALTY_USER_NUMBER>nvl(temp.s_count,0)
	   and staff.dep_id in (select dep_id from staff where staff_id=#{staffId})
	   order by staff.staff_name
	 ) where  rownum &lt; 6
  </select>

</mapper>