<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.unique.org.dao.DepMapper" >
  <resultMap id="BaseResultMap" type="com.unique.org.po.Dep" >
    <id column="DEP_ID" property="depId" jdbcType="DECIMAL" />
    <result column="ORG_ID" property="orgId" jdbcType="DECIMAL" />
    <result column="DEP_TYPE_ID" property="depTypeId" jdbcType="DECIMAL" />
    <result column="DEP_CODE" property="depCode" jdbcType="VARCHAR" />
    <result column="DEP_NAME" property="depName" jdbcType="VARCHAR" />
    <result column="DEP_ADDR" property="depAddr" jdbcType="VARCHAR" />
    <result column="SERIAL_NO" property="serialNo" jdbcType="DECIMAL" />
    <result column="PARENT_ID" property="parentId" jdbcType="DECIMAL" />
    <result column="IS_LEAF" property="isLeaf" jdbcType="CHAR" />
    <result column="NODE_LEVEL" property="nodeLevel" jdbcType="DECIMAL" />
    <result column="SORT_RANK" property="sortRank" jdbcType="DECIMAL" />
    <result column="STATUS" property="status" jdbcType="CHAR" />
    <result column="OPERATOR" property="operator" jdbcType="DECIMAL" />
    <result column="OP_TIME" property="opTime" jdbcType="TIMESTAMP" />
    <result column="OPERATOR_NAME" property="operatorName" jdbcType="VARCHAR" />
    <result column="IS_RECOMMEND" property="isRecommend" jdbcType="CHAR" />
    <result column="depIcon" property="depIcon" jdbcType="VARCHAR"/>
  </resultMap>
  <resultMap id="ResultMapWithBLOBs" type="com.unique.org.po.Dep" extends="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <result column="DEP_REMARK" property="depRemark" jdbcType="CLOB" />
    <result column="depImage"   property="depImage" jdbcType="VARCHAR"/>
  </resultMap>
  
  <resultMap id="DepKeyMap" type="com.unique.org.po.DepKey">
        <result property="keyId" column="KEY_ID" jdbcType="DECIMAL"/>
        <result property="depId" column="DEP_ID" jdbcType="DECIMAL"/>
        <result property="orgId" column="ORG_ID" jdbcType="DECIMAL"/>
        <result property="keyName" column="KEY_NAME" jdbcType="VARCHAR"/>
        <result property="status" column="STATUS" jdbcType="CHAR"/>
        <result property="operator" column="OPERATOR" jdbcType="DECIMAL"/>
        <result property="opTime" column="OP_TIME" jdbcType="TIMESTAMP"/>
        <result property="operatorName" column="OPERATOR_NAME" jdbcType="VARCHAR"/>
	</resultMap>
	
	<!-- 用于select查询公用抽取的列 -->
	<sql id="columns">
	    <![CDATA[
		m.KEY_ID,m.DEP_ID,m.ORG_ID,m.KEY_NAME,m.STATUS,m.OPERATOR,m.OP_TIME,m.OPERATOR_NAME
	    ]]>
	</sql>
  
    <!-- 根据机构查询 一级科室列表 -->
	<select id="get1stLevlDep" resultMap="BaseResultMap" parameterType="map">
		 	SELECT * from DEP t
			WHERE PARENT_ID IS NULL
			AND IS_LEAF='N'
			AND DEP_TYPE_ID=2
			AND (status='C' or status='U')
			AND ORG_ID in
			<foreach collection="orgIds"  open="(" close=")" item="orgId" separator=",">
				#{orgId}
			</foreach>
			order by SORT_RANK
	</select>
	
	<!-- 根据机构and一级科室查询 2级科室列表 -->
	<select id="get2ndLevlDep" resultMap="ResultMapWithBLOBs" parameterType="java.util.Map">
		<![CDATA[
		 	SELECT t.*,m.hlink_to as depImage from DEP t
		 	left join (
		 		 select c.hlink_to,c.dep_id from cms_img_lib c
				 join cms_img_type_use_rel r on c.type_use_id=r.type_use_id
				 join cms_img_use u on u.img_use_id=r.img_use_id
				 join cms_img_type t on t.img_type_id=r.img_type_id
	 			 where t.img_type_code='DEP_ID' and u.img_use_code='depsytp'
				) m 	
  	  		on m.dep_id=t.dep_id 
			where IS_LEAF='Y'
			AND ORG_ID=#{orgId}
			AND PARENT_ID=#{parentId}
			AND DEP_TYPE_ID=2
			AND (status='C' or status='U')
			order by SORT_RANK
		 	]]>
	</select>
	
	<!-- 查询有排班的科室 -->
	<select id="getDutyDep" resultMap="ResultMapWithBLOBs" parameterType="java.util.Map">
		<![CDATA[
		 	SELECT t.*,m.hlink_to as depImage from DEP t
		 	left join (
		 		 select c.hlink_to,c.dep_id from cms_img_lib c
				 join cms_img_type_use_rel r on c.type_use_id=r.type_use_id
				 join cms_img_use u on u.img_use_id=r.img_use_id
				 join cms_img_type t on t.img_type_id=r.img_type_id
	 			 where t.img_type_code='DEP_ID' and u.img_use_code='depsytp'
				) m 	
  	  		on m.dep_id=t.dep_id 
			where 
			 exists (
			  select 1 from MC_DUTY md  
			  join STAFF st on md.staff_id=st.staff_id 
			  where t.dep_id=md.dep_id
			  and st.status in ('C','U') and md.status in ('C','U')
			  and md.reg_num_remain >0
			  and md.duty_date >= sysdate
					and md.duty_date < sysdate + nvl(st.duty_date_num,7)
			 )
			AND t.IS_LEAF='Y'
			AND t.ORG_ID=#{orgId}
			AND t.PARENT_ID=#{parentId}
			AND t.DEP_TYPE_ID=2
			AND (t.status='C' or t.status='U')
			AND not exists (select 1 from dep d where d.dep_id = t.dep_id and d.dep_name in ('医保科','外联办')) 
			order by t.SORT_RANK
		 	]]>
	</select>
	
	<!-- <resultMap type="com.unique.org.po.Dep" id="depInfoImageMap" extends="ResultMapWithBLOBs">
		<collection property="listImage" javaType="com.unique.system.po.ImageInfo" >
			<result column="imageUrl" property="imageUrl"/>
		</collection> m.hlink_to as imageUrl 
	</resultMap> -->
	
	<select id="getDepInfo" resultMap="ResultMapWithBLOBs" parameterType="string">
		select d.*,m.hlink_to as depImage from dep d
		left join 
			(select c.hlink_to,c.dep_id from cms_img_lib c where 
				c.type_use_id =
					(select max(m.TYPE_USE_ID) use_id from cms_img_use c , cms_img_type_use_rel m where 
					c.img_use_id=m.img_use_id and c.img_use_code='depsytp')
				and rownum = 1
			) m 	
  	  	on m.dep_id=d.dep_id
		 where d.dep_id = #{depId,jdbcType=DECIMAL}
	
	</select>
	<!-- ResultMapWithBLOBs m.hlink_to depImage -->
	<select id="getDepInfoByCode" resultMap="ResultMapWithBLOBs" parameterType="string">
		select d.*,m.hlink_to as depImage from dep d
		left join 
  	  		(select c.hlink_to,c.dep_id from cms_img_lib c where 
				c.type_use_id =
					(select max(m.TYPE_USE_ID) use_id from cms_img_use c , cms_img_type_use_rel m where c.img_use_id=m.img_use_id and c.img_use_code='depsytp')
			) m
  	  	on m.dep_id=d.dep_id 
  	 	where d.dep_code = #{depCode}
	</select>
	
  <insert id="addDep" parameterType="com.unique.org.po.Dep" >
     <selectKey keyProperty="depId" resultType="DECIMAL" order="BEFORE">
            select dep_sequence.nextval as depId from dual
     </selectKey>
    insert into DEP (DEP_ID, ORG_ID, DEP_TYPE_ID, 
      DEP_CODE, DEP_NAME, DEP_ADDR, 
      SERIAL_NO, PARENT_ID, IS_LEAF, 
      NODE_LEVEL, SORT_RANK, STATUS, 
      OPERATOR, OP_TIME, OPERATOR_NAME, 
      DEP_REMARK,IS_RECOMMEND)
    values (#{depId,jdbcType=DECIMAL}, #{orgId,jdbcType=DECIMAL}, #{depTypeId,jdbcType=DECIMAL}, 
      #{depCode,jdbcType=VARCHAR}, #{depName,jdbcType=VARCHAR}, #{depAddr,jdbcType=VARCHAR}, 
      #{serialNo,jdbcType=VARCHAR}, #{parentId,jdbcType=DECIMAL}, #{isLeaf,jdbcType=CHAR}, 
      #{nodeLevel,jdbcType=DECIMAL}, #{sortRank,jdbcType=DECIMAL}, #{status,jdbcType=CHAR}, 
      #{operator,jdbcType=DECIMAL}, #{opTime,jdbcType=TIMESTAMP}, #{operatorName,jdbcType=VARCHAR}, 
      #{depRemark,jdbcType=CLOB},#{isRecommend,jdbcType=CHAR})
  </insert>
  
  <!-- 获取医院的重点科室 -->
  <select id="getAkeyDep" resultMap="BaseResultMap" parameterType="string">
   <![CDATA[
   	  select 
   	  		d.DEP_ID, d.DEP_CODE, d.DEP_NAME , m.hlink_to depIcon 
   	  from dep d
  	  left join 
  	  		(select c.hlink_to,c.dep_id from cms_img_lib c 
  	  		 where c.type_use_id = 
			(select max(m.TYPE_USE_ID) use_id from cms_img_use c , cms_img_type_use_rel m where c.img_use_id=m.img_use_id and c.img_use_code='depicon')
  	  	   ) m 
  	  on m.dep_id=d.dep_id
  	  where d.org_id = #{orgId} and d.IS_RECOMMEND = 'Y' and d.STATUS='C' and rownum < 9 
   ]]>
  </select>
  
  <select id="getDepsByKeyName" parameterType="map" resultMap="BaseResultMap">
   <![CDATA[
	select c.*,m.hlink_to depIcon  from dep c
	left join 
		(select c.hlink_to,c.dep_id from cms_img_lib c where 
			c.type_use_id = 
			(select max(m.TYPE_USE_ID) use_id from cms_img_use c , cms_img_type_use_rel m where c.img_use_id=m.img_use_id and c.img_use_code='depicon')
		) m 
	on m.dep_id = c.dep_id
	left join dep p on c.parent_id = p.dep_id
	left join dep_key on c.dep_id = dep_key.dep_id
	where dep_key.key_name = #{keyWord}
	and p.dep_id = #{depTypeId}
	and c.dep_id in
	(
	  select mc_duty.dep_id from mc_duty
	  left join dep on dep.dep_id = mc_duty.dep_id 
	  left join staff on staff.staff_id = mc_duty.staff_id
	  where dep.parent_id = #{depTypeId}
	  and mc_duty.status in ('C','U')
	  and mc_duty.duty_date > sysdate
	  and  mc_duty.duty_date < sysdate + nvl(staff.duty_date_num,7) + 1
	)
 	]]>
  </select>
  
  <select id="getDepDutyByDepTypeId" parameterType="map" resultMap="BaseResultMap">
  		<![CDATA[
	select c.*,m.hlink_to depIcon  from dep c
	left join 
	  (select c.hlink_to,c.dep_id from cms_img_lib c where 
			c.type_use_id = 
			(select max(m.TYPE_USE_ID) use_id from cms_img_use c , cms_img_type_use_rel m where c.img_use_id=m.img_use_id and c.img_use_code='depicon')
		) m  
	   on m.dep_id = c.dep_id
	left join dep p on c.parent_id = p.dep_id
	where   p.dep_id = #{depTypeId}  
	and c.dep_id in
	(
	  select mc_duty.dep_id from mc_duty
	  left join dep on dep.dep_id = mc_duty.duty_id 
	  left join staff on staff.staff_id = mc_duty.staff_id
	  where dep.parent_id = #{depTypeId}
	  and mc_duty.status in ('C','U')
	  and mc_duty.duty_date > sysdate
	  and mc_duty.duty_date < sysdate + nvl(staff.duty_date_num,7) + 1
	)
 	]]>
  </select>
  
  <!-- 查询所有的科室查询关键字 -->
  <select id="getDepKeyByDepId" resultMap="DepKeyMap" parameterType="string">
  		select distinct <include refid="columns"/> from dep_key m
  		where  m.dep_id in (select dep_id from dep where dep.parent_id=#{depId} or dep.dep_id=#{depId}) and  m.status='C'    
  </select>
  <!-- 通过depName查询dep -->
  <select id="getDepByDepName" parameterType="map" resultMap="BaseResultMap">
  	select * from dep where dep.org_id=#{orgId} and dep.dep_name=#{depName} and dep.status in ('C','U') and rownum = 1
  </select>
</mapper>